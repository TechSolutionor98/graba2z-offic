"use client"

import { useState, useEffect, useRef } from "react"
import { useLanguage } from "../context/LanguageContext"
import { getCachedTranslation } from "../LanguageModel/translationService"

// Common UI phrases dictionary for accurate translations
const uiDictionary = {
  // Buttons & Actions
  "Add to Cart": "أضف إلى السلة",
  "Add To Cart": "أضف إلى السلة",
  "Buy Now": "اشتري الآن",
  "View All": "عرض الكل",
  "View all results": "عرض جميع النتائج",
  "See All": "عرض الكل",
  "Shop Now": "تسوق الآن",
  "Learn More": "اعرف المزيد",
  "Learn more": "اعرف المزيد",
  "Read More": "اقرأ المزيد",
  "Load More": "تحميل المزيد",
  "Submit": "إرسال",
  "Cancel": "إلغاء",
  "Confirm": "تأكيد",
  "Save": "حفظ",
  "Delete": "حذف",
  "Edit": "تعديل",
  "Close": "إغلاق",
  "Back": "رجوع",
  "Next": "التالي",
  "Previous": "السابق",
  "Continue": "متابعة",
  "Continue Shopping": "متابعة التسوق",
  
  // Navigation
  "Home": "الرئيسية",
  "Shop": "المتجر",
  "Cart": "السلة",
  "Wishlist": "قائمة الأمنيات",
  "My Wishlist": "قائمة أمنياتي",
  "Profile": "الملف الشخصي",
  "My Profile": "ملفي الشخصي",
  "My Orders": "طلباتي",
  "Track Order": "تتبع الطلب",
  "Login": "تسجيل الدخول",
  "Logout": "تسجيل الخروج",
  "Register": "التسجيل",
  "Sign In": "تسجيل الدخول",
  "Sign Up": "إنشاء حساب",
  "Search": "بحث",
  "All Categories": "جميع الفئات",
  "All Category": "جميع الفئات",
  
  // Product Detail Page
  "Key Features": "الميزات الرئيسية",
  "Current Item": "المنتج الحالي",
  "Pay in 4 simple, interest free payments of": "ادفع على 4 أقساط بسيطة بدون فوائد بقيمة",
  "As low as": "بأقل من",
  "or": "أو",
  "4 interest-free payments.": "4 دفعات بدون فوائد.",
  
  // Product related
  "In Stock": "متوفر",
  "Out of Stock": "غير متوفر",
  "Limited Stock": "مخزون محدود",
  "Pre-order": "طلب مسبق",
  "Price": "السعر",
  "Quantity": "الكمية",
  "Description": "الوصف",
  "Product Description": "وصف المنتج",
  "Product": "المنتج",
  "Specifications": "المواصفات",
  "Reviews": "التقييمات",
  "Category": "الفئة",
  "Brand": "العلامة التجارية",
  "SKU": "رقم المنتج",
  "Inclusive VAT": "شامل الضريبة",
  "Off": "خصم",
  "More Information": "معلومات إضافية",
  "More": "المزيد",
  "Information": "معلومات",
  "Model Number": "رقم الموديل",
  "Warranty": "الضمان",
  "Buy Now": "اشتري الآن",
  "You save": "توفيرك",
  "Bundle price": "سعر الحزمة",
  "with bundle discount!": "مع خصم الحزمة!",
  "OFF BUNDLE": "خصم الحزمة",
  "Chat With Specialist": "تحدث مع متخصص",
  "Request a Callback": "طلب معاودة الاتصال",
  "Payment Methods": "طرق الدفع",
  "Get My Coupon": "احصل على كوبوني",
  "Free shipping when you spend AED500 & above. Unlimited destinations in Dubai and Abu Dhabi": "شحن مجاني عند إنفاق 500 درهم وأكثر. وجهات غير محدودة في دبي وأبوظبي",
  "Get Coupons": "احصل على الكوبونات",
  "Express Delivery": "التوصيل السريع",
  "Delivery & Returns Policy": "سياسة التوصيل والإرجاع",
  "Delivery in remote areas will be considered as normal delivery which takes place with 1 working day delivery.": "سيتم اعتبار التوصيل في المناطق النائية كتوصيل عادي يتم خلال يوم عمل واحد.",
  "Warranty Information": "معلومات الضمان",
  "Standard warranty applies as per manufacturer terms": "يسري الضمان القياسي وفقاً لشروط الشركة المصنعة",
  "Protect Your Purchase": "احمِ مشترياتك",
  "Including VAT": "شامل الضريبة",
  "You Save": "توفيرك",
  "Available in stock": "متوفر في المخزون",
  "Currently out of stock": "غير متوفر حالياً",
  "Available for pre-order": "متاح للطلب المسبق",
  "Available Options": "الخيارات المتاحة",
  "Click on any variation to view its details": "انقر على أي خيار لعرض تفاصيله",
  "Request Bulk Purchase": "طلب شراء بالجملة",
  "Color": "اللون",
  "Select Color": "اختر اللون",
  "N/A": "غير متوفر",
  "For": "لـ",
  "item": "منتج",
  "items": "منتجات",
  "Add all": "أضف الكل",
  "to Cart": "إلى السلة",
  "Save": "وفر",
  
  // Cart & Checkout
  "Shopping Cart": "سلة التسوق",
  "Your cart is empty": "سلة التسوق فارغة",
  "Subtotal": "المجموع الفرعي",
  "Total": "الإجمالي",
  "Checkout": "إتمام الشراء",
  "Proceed to Checkout": "المتابعة للدفع",
  "Apply Coupon": "تطبيق الكوبون",
  "Remove": "إزالة",
  "Total Save": "إجمالي التوفير",
  "Bundle Total": "إجمالي الحزمة",
  "Frequently Bought Together": "يشترى معاً بشكل متكرر",
  "Remove Bundle": "إزالة الحزمة",
  
  // Account
  "Email": "البريد الإلكتروني",
  "Password": "كلمة المرور",
  "Confirm Password": "تأكيد كلمة المرور",
  "Forgot Password?": "نسيت كلمة المرور؟",
  "Remember Me": "تذكرني",
  "First Name": "الاسم الأول",
  "Last Name": "اسم العائلة",
  "Phone": "رقم الهاتف",
  "Address": "العنوان",
  "City": "المدينة",
  "Country": "الدولة",
  
  // Categories (common ones)
  "Gaming Zone": "منطقة الألعاب",
  "Security & Surveillance": "الأمن والمراقبة",
  "Mobiles & Tablets": "الهواتف والأجهزة اللوحية",
  "Electronics & Home": "الإلكترونيات والمنزل",
  "Computers": "أجهزة الكمبيوتر",
  "Accessories": "الإكسسوارات",
  "Computer Accessories": "ملحقات الكمبيوتر",
  "Camera & Photo": "الكاميرات والتصوير",
  "Cameras": "الكاميرات",
  "Laptops": "أجهزة اللابتوب",
  "Desktops": "أجهزة سطح المكتب",
  "Monitors": "الشاشات",
  "Printers": "الطابعات",
  "Networking": "الشبكات",
  "Storage": "التخزين",
  "Software": "البرامج",
  "Audio": "الصوتيات",
  "Speakers": "مكبرات الصوت",
  "Headphones": "سماعات الرأس",
  "Smart Home": "المنزل الذكي",
  "Smart Watches": "الساعات الذكية",
  "Wearables": "الأجهزة القابلة للارتداء",
  "Power Banks": "شواحن متنقلة",
  "Cables & Adapters": "الكابلات والمحولات",
  "Cases & Covers": "الحافظات والأغطية",
  "Screen Protectors": "واقيات الشاشة",
  "Keyboards": "لوحات المفاتيح",
  "Mouse": "الفأرة",
  "Mice": "الفأرة",
  "Gaming Chairs": "كراسي الألعاب",
  "Gaming Headsets": "سماعات الألعاب",
  "Gaming Controllers": "وحدات تحكم الألعاب",
  "PlayStation": "بلايستيشن",
  "Xbox": "إكس بوكس",
  "Nintendo": "نينتندو",
  "TV": "تلفزيون",
  "Television": "تلفزيون",
  "Refrigerator": "ثلاجة",
  "Washing Machine": "غسالة",
  "Air Conditioner": "مكيف هواء",
  "Vacuum Cleaner": "مكنسة كهربائية",
  "Kitchen Appliances": "أجهزة المطبخ",
  "Home Appliances": "الأجهزة المنزلية",
  "Tablets": "الأجهزة اللوحية",
  "Mobile Phones": "الهواتف المحمولة",
  "Smartphones": "الهواتف الذكية",
  "iPhone": "آيفون",
  "Samsung": "سامسونج",
  "Apple": "أبل",
  "Huawei": "هواوي",
  "Xiaomi": "شاومي",
  "CCTV": "كاميرات المراقبة",
  "Security Cameras": "كاميرات الأمان",
  "Drones": "الطائرات بدون طيار",
  "More": "المزيد",
  
  // Footer
  "About Us": "من نحن",
  "Contact Us": "اتصل بنا",
  "Privacy Policy": "سياسة الخصوصية",
  "Terms & Conditions": "الشروط والأحكام",
  "Refund Policy": "سياسة الاسترداد",
  "FAQ": "الأسئلة الشائعة",
  "Help Center": "مركز المساعدة",
  "Top Categories": "أفضل الفئات",
  "More Categories": "المزيد من الفئات",
  "Categories": "الفئات",
  "Legal": "قانوني",
  "Support": "الدعم",
  "Connect": "تواصل",
  "Subscribe": "اشترك",
  "Blog": "المدونة",
  "Shop": "المتجر",
  "Login": "تسجيل الدخول",
  "Register": "التسجيل",
  "Wishlist": "قائمة الأمنيات",
  "Cart": "السلة",
  "Refund and Return": "الاسترداد والإرجاع",
  "Cookies Policy": "سياسة ملفات تعريف الارتباط",
  "Disclaimer Policy": "سياسة إخلاء المسؤولية",
  "Voucher Terms": "شروط القسيمة",
  "Delivery Terms": "شروط التوصيل",
  
  // Messages
  "Added to cart": "تمت الإضافة إلى السلة",
  "Added to wishlist": "تمت الإضافة إلى قائمة الأمنيات",
  "Removed from wishlist": "تمت الإزالة من قائمة الأمنيات",
  
  // Wishlist Page
  "My Wishlist": "قائمة أمنياتي",
  "Your wishlist is empty": "قائمة أمنياتك فارغة",
  "Start adding items you love to your wishlist": "ابدأ بإضافة المنتجات التي تحبها إلى قائمة أمنياتك",
  "Browse Products": "تصفح المنتجات",
  "Loading...": "جاري التحميل...",
  
  // Login/Register Pages
  "Welcome back": "مرحباً بعودتك",
  "Email address": "عنوان البريد الإلكتروني",
  "Remember me": "تذكرني",
  "Forgot password?": "نسيت كلمة المرور؟",
  "Sign in": "تسجيل الدخول",
  "Continue as Guest": "المتابعة كضيف",
  "Don't have an account?": "ليس لديك حساب؟",
  "Create your account": "إنشاء حسابك",
  "sign in to your existing account": "تسجيل الدخول إلى حسابك الحالي",
  "Full Name": "الاسم الكامل",
  "Email Address": "عنوان البريد الإلكتروني",
  "Create Account": "إنشاء حساب",
  "Creating Account...": "جاري إنشاء الحساب...",
  "By creating an account, you agree to our": "بإنشاء حساب، فإنك توافق على",
  "Or": "أو",
  
  // Track Order Page
  "Track Your Order": "تتبع طلبك",
  "Order ID": "رقم الطلب",
  
  // Contact Page
  "We'd love to hear from you!": "يسعدنا أن نسمع منك!",
  "Your Name": "اسمك",
  "Your Email": "بريدك الإلكتروني",
  "Phone Number": "رقم الهاتف",
  "Message": "الرسالة",
  "Send Request": "إرسال الطلب",
  "Submitting...": "جاري الإرسال...",
  "Request submitted successfully!": "تم إرسال الطلب بنجاح!",
  "We look forward to hearing from you.": "نتطلع للسماع منك.",
  
  // About Page
  "Our Vision": "رؤيتنا",
  "Our Mission": "مهمتنا",
  "Core Values": "قيمنا الأساسية",
  "Integrity": "النزاهة",
  "Maintaining honesty and transparency in all our dealings": "الحفاظ على الصدق والشفافية في جميع تعاملاتنا",
  "Innovation": "الابتكار",
  "Embracing new technologies and ideas to stay ahead": "تبني التقنيات والأفكار الجديدة للبقاء في المقدمة",
  "Customer Focus": "التركيز على العميل",
  "Prioritizing customer needs in every decision": "إعطاء الأولوية لاحتياجات العملاء في كل قرار",
  "Excellence": "التميز",
  "Striving for superior quality in products and services": "السعي للجودة العالية في المنتجات والخدمات",
  "Teamwork": "العمل الجماعي",
  "Fostering collaboration to achieve shared goals": "تعزيز التعاون لتحقيق الأهداف المشتركة",
  "Our Product Range": "مجموعة منتجاتنا",
  
  // Contact Information Section (common across pages)
  "Contact Information": "معلومات الاتصال",
  "Get in touch with our team for any questions or concerns": "تواصل مع فريقنا لأي أسئلة أو استفسارات",
  "Hours": "ساعات العمل",
  "Daily 9:00 AM - 7:00 PM": "يومياً من 9:00 صباحاً حتى 7:00 مساءً",
  "P.O. Box 241975, Dubai, UAE": "ص.ب 241975، دبي، الإمارات",
  "Powered by Crown Excel General Trading LLC": "مدعوم من كراون إكسل للتجارة العامة ش.ذ.م.م",
  
  // Policy Pages Headers
  "Return & Refund & Exchange Policy": "سياسة الإرجاع والاسترداد والاستبدال",
  "Return Eligibility": "أهلية الإرجاع",
  "Return Methods": "طرق الإرجاع",
  "Cookies & Tracking Technologies": "ملفات تعريف الارتباط وتقنيات التتبع",
  "Important Notice": "ملاحظة مهمة",
  "Disclosure to Third Parties": "الإفصاح لأطراف ثالثة",
  "Analysis Services": "خدمات التحليل",
  "Google Analytics": "جوجل أناليتكس",
  "Sentry": "سنتري",
  "Your Users' Rights": "حقوق المستخدمين",
  "Email & Postal Communication": "التواصل عبر البريد الإلكتروني والبريد",
  "Links to External Websites": "روابط إلى مواقع خارجية",
  "Data Security": "أمن البيانات",
  "Updates to Privacy Notice": "تحديثات إشعار الخصوصية",
  "Your Consent": "موافقتك",
  "Disclaimer Policy": "سياسة إخلاء المسؤولية",
  "Limitation of Liability and Disclaimers": "حدود المسؤولية وإخلاء المسؤولية",
  "User Agreement and Limitation of Liability": "اتفاقية المستخدم وحدود المسؤولية",
  "Site Security and Acceptable Use": "أمان الموقع والاستخدام المقبول",
  "Content Accuracy and Updates": "دقة المحتوى والتحديثات",
  "No Warranty for Travel, Shipping, or Advisory Content": "لا ضمان للمحتوى المتعلق بالسفر أو الشحن أو الاستشارات",
  "Introduction": "المقدمة",
  "1. Membership Eligibility": "1. أهلية العضوية",
  "2. Account & Registration": "2. الحساب والتسجيل",
  "3. Pricing & Orders": "3. الأسعار والطلبات",
  "4. Order Cancellation": "4. إلغاء الطلب",
  "5. Third-Party & Branded Product Disclaimer": "5. إخلاء المسؤولية عن منتجات الطرف الثالث والعلامات التجارية",
  "6. Payment & Credit Card Information": "6. معلومات الدفع وبطاقة الائتمان",
  
  // Voucher Terms Page
  "Voucher Terms & Conditions": "شروط وأحكام القسيمة",
  "General Conditions": "الشروط العامة",
  "How to Apply a Voucher or Discount Code": "كيفية تطبيق القسيمة أو كود الخصم",
  "In-Store Voucher Codes (for Mobile App Use Only)": "أكواد القسائم في المتجر (للاستخدام على تطبيق الهاتف فقط)",
  
  // Delivery Terms Page
  "Delivery Information": "معلومات التوصيل",
  "we are committed to delivering your orders efficiently and reliably across the United Arab Emirates. Please review the following delivery options, charges, and terms:": "نحن ملتزمون بتوصيل طلباتكم بكفاءة وموثوقية في جميع أنحاء الإمارات العربية المتحدة. يرجى مراجعة خيارات التوصيل والرسوم والشروط التالية:",
  "Standard Delivery to Your Doorstep (UAE Only)": "التوصيل القياسي إلى باب منزلك (الإمارات فقط)",
  "Order Value wise Shipping Fee": "رسوم الشحن حسب قيمة الطلب",
  "Payment Methods Available": "طرق الدفع المتاحة",
  "In-Store Pickup": "الاستلام من المتجر",
  "Delivery Policy for Retail": "سياسة التوصيل للبيع بالتجزئة",
  "Delivery Schedule:": "جدول التوصيل:",
  "Possible Delays:": "التأخيرات المحتملة:",
  "Change of Delivery Address:": "تغيير عنوان التوصيل:",
  "Bulk Orders Delivery Information": "معلومات توصيل الطلبات بالجملة",
  "Shipping Costs": "تكاليف الشحن",
  "How It Works:": "كيف يعمل:",
  "Contact for Bulk Orders:": "للتواصل حول الطلبات بالجملة:",
  "Customer Service:": "خدمة العملاء:",
  
  // Shop Page - Filters
  "Filters": "الفلاتر",
  "Active Filters": "الفلاتر النشطة",
  "Clear All": "مسح الكل",
  "Clear All Filters": "مسح جميع الفلاتر",
  "Apply": "تطبيق",
  "Subcategory": "الفئة الفرعية",
  "Level 2": "المستوى 2",
  "Level 3": "المستوى 3",
  "Level 4": "المستوى 4",
  "Stock": "المخزون",
  "Stock Status": "حالة المخزون",
  "On Sale": "معروض للبيع",
  "Price Range": "نطاق السعر",
  "No brands found": "لم يتم العثور على علامات تجارية",
  "Current Path": "المسار الحالي",
  
  // Shop Page - Sorting
  "Newest First": "الأحدث أولاً",
  "Price: Low to High": "السعر: من الأقل للأعلى",
  "Price: High to Low": "السعر: من الأعلى للأقل",
  "Name: A to Z": "الاسم: أ إلى ي",
  "Name: Z to A": "الاسم: ي إلى أ",
  "Best Selling": "الأكثر مبيعاً",
  "Top Rated": "الأعلى تقييماً",
  
  // Shop Page - Results
  "All Products": "جميع المنتجات",
  "Products": "المنتجات",
  "products found": "منتج تم العثور عليه",
  "No products found": "لم يتم العثور على منتجات",
  "Try adjusting your filters or search terms": "حاول تعديل الفلاتر أو مصطلحات البحث",
  "Load More": "تحميل المزيد",
  "Show": "عرض",
  "Results for": "نتائج البحث عن",
  "Showing results for": "عرض نتائج",
  "instead": "بدلاً من ذلك",
  "Brands": "العلامات التجارية",
  
  // Core Service Section
  "Core Service Aspects": "جوانب الخدمة الأساسية",
  "Secure Payment Method": "طريقة دفع آمنة",
  "Available Different secure Payment Methods": "طرق دفع آمنة ومتنوعة متاحة",
  "Extreme Fast Delivery": "توصيل سريع للغاية",
  "Fast and convenient From door to door delivery": "توصيل سريع ومريح من الباب إلى الباب",
  "Quality & Savings": "الجودة والتوفير",
  "Comprehensive quality control and affordable price": "مراقبة جودة شاملة وأسعار معقولة",
  "Professional Support": "دعم احترافي",
  "Efficient customer support from passionate team": "دعم عملاء فعال من فريق متحمس",
  
  // Cart Page
  "Available Coupons": "القسائم المتاحة",
  "Order Summary": "ملخص الطلب",
  "item": "منتج",
  "items": "منتجات",
  "Original Price": "السعر الأصلي",
  "Our Price": "سعرنا",
  "You Save": "توفيرك",
  "Discounted Price": "السعر المخفض",
  "Total Savings": "إجمالي التوفير",
  "Delivery Options": "خيارات التوصيل",
  "Free Delivery": "توصيل مجاني",
  "Shipping": "الشحن",
  "Free": "مجاني",
  "Protection Plans": "خطط الحماية",
  "VAT Included": "شامل الضريبة",
  "Coupon": "القسيمة",
  "Coupon:": "القسيمة:",
  "Total Amount": "المبلغ الإجمالي",
  "Free shipping on orders over": "شحن مجاني للطلبات أكثر من",
  "for free shipping": "للشحن المجاني",
  "By proceeding you agree to our": "بالمتابعة أنت توافق على",
  "Terms of Service": "شروط الخدمة",
  "and": "و",
  "Remove from cart": "إزالة من السلة",
  "Add more items to your cart before checkout.": "أضف المزيد من المنتجات إلى سلتك قبل إتمام الشراء.",
  "Your cart is empty. Add some products to continue!": "سلة التسوق فارغة. أضف بعض المنتجات للمتابعة!",
  
  // Checkout Page - Steps
  "Shipping Details": "تفاصيل الشحن",
  "Summary": "الملخص",
  "Payment Method": "طريقة الدفع",
  
  // Checkout Page - Delivery
  "Home Delivery": "التوصيل للمنزل",
  "Pickup From Store": "الاستلام من المتجر",
  "Store Pickup": "الاستلام من المتجر",
  "Contact Details": "تفاصيل الاتصال",
  "E-mail": "البريد الإلكتروني",
  "Phone number": "رقم الهاتف",
  "Phone:": "الهاتف:",
  "Shipping Address": "عنوان الشحن",
  "Edit Address": "تعديل العنوان",
  "Remove Address": "إزالة العنوان",
  "Back to Cart": "العودة للسلة",
  "Continue Summary": "متابعة الملخص",
  "Continue to Summary": "المتابعة إلى الملخص",
  "Where do you want to pick up?": "أين تريد الاستلام؟",
  "Select Store": "اختر المتجر",
  "Select a store to view location": "اختر متجراً لعرض الموقع",
  "Choose from the stores on the left": "اختر من المتاجر على اليسار",
  
  // Checkout Page - Order Summary & Notes
  "Delivery Details": "تفاصيل التوصيل",
  "Order Notes (Optional)": "ملاحظات الطلب (اختياري)",
  "Add a note to your order:": "أضف ملاحظة لطلبك:",
  "Continue to Payment": "المتابعة للدفع",
  
  // Checkout Page - Payment
  "Cash on Delivery": "الدفع عند الاستلام",
  "You will pay in cash when your order is delivered to your address. Please have the exact amount ready.": "ستدفع نقداً عند توصيل طلبك لعنوانك. يرجى تجهيز المبلغ المطلوب.",
  "Buy Now, Pay Later": "اشترِ الآن، ادفع لاحقاً",
  "Split your purchase into 3 interest-free installments with Tamara.": "قسّم مشترياتك على 3 أقساط بدون فوائد مع تمارا.",
  "Split into 4 Payments": "قسّم على 4 دفعات",
  "Split your purchase into 4 interest-free installments with Tabby.": "قسّم مشترياتك على 4 أقساط بدون فوائد مع تابي.",
  "Card Payment": "الدفع بالبطاقة",
  "Pay securely with your credit or debit card.": "ادفع بأمان ببطاقتك الائتمانية أو بطاقة الخصم.",
  "Processing...": "جاري المعالجة...",
  
  // Checkout Page - Sidebar
  "Review your order": "راجع طلبك",
  "Color:": "اللون:",
  "OS:": "نظام التشغيل:",
  "Qty:": "الكمية:",
  "Show less": "عرض أقل",
  "more items": "منتجات إضافية",
  "Sale Price Total": "إجمالي سعر البيع",
  "Our Offer Price": "سعر عرضنا",
  "Applying...": "جاري التطبيق...",
  "Purchase for": "اشترِ بقيمة",
  "or more to enable free shipping": "أو أكثر للحصول على شحن مجاني",
  "You qualify for free shipping!": "أنت مؤهل للشحن المجاني!",
  "Your order is secure and encrypted. We never store your payment information.": "طلبك آمن ومشفر. نحن لا نخزن معلومات الدفع الخاصة بك أبداً.",
  
  // Address Modal
  "Address Details": "تفاصيل العنوان",
  "Office": "المكتب",
  "Zip Code": "الرمز البريدي",
  "State/Region": "الولاية/المنطقة",
  "Default Address": "العنوان الافتراضي",
  "Save Address": "حفظ العنوان",
  
  // Empty Cart & Checkout messages
  "Add some items to your cart before checkout.": "أضف بعض المنتجات إلى سلتك قبل إتمام الشراء.",
}

/**
 * TranslatedText - Component that translates text
 * Uses dictionary for common phrases, uses Model API for dynamic content
 * OPTIMIZED: Uses batched translation queue for efficient API calls
 */
const TranslatedText = ({ 
  text, 
  children,
  fallback = null, 
  className = "", 
  as: Component = "span",
  skipTranslation = false,
  useModelOnly = false // Force use of translation model (skip dictionary)
}) => {
  const { currentLanguage, translate } = useLanguage()
  const sourceText = text || (typeof children === 'string' ? children : null)
  const [apiTranslation, setApiTranslation] = useState(null)
  const [isTranslating, setIsTranslating] = useState(false)
  const mountedRef = useRef(true)
  const translationRequestedRef = useRef(false)
  
  // Cleanup on unmount
  useEffect(() => {
    mountedRef.current = true
    return () => {
      mountedRef.current = false
    }
  }, [])
  
  // Check dictionary synchronously - ALWAYS check dictionary first
  const getDictionaryTranslation = () => {
    if (!sourceText || currentLanguage.code === "en" || skipTranslation || useModelOnly) {
      return null
    }
    const translation = uiDictionary[sourceText] || uiDictionary[sourceText.trim()] || null
    return translation
  }

  const dictTranslation = getDictionaryTranslation()
  
  // Check if already cached in translation service
  const getCachedApiTranslation = () => {
    if (!sourceText || currentLanguage.code === "en" || skipTranslation || dictTranslation) {
      return null
    }
    return getCachedTranslation(sourceText, 'en-ar')
  }

  // For dynamic content not in dictionary, use API (batched internally)
  useEffect(() => {
    const fetchTranslation = async () => {
      // Skip if: English, no text, already have dict translation, or skip flag
      if (currentLanguage.code === "en" || !sourceText || skipTranslation || dictTranslation) {
        setApiTranslation(null)
        translationRequestedRef.current = false
        return
      }
      
      // Check if already cached
      const cached = getCachedTranslation(sourceText, 'en-ar')
      if (cached) {
        if (mountedRef.current) {
          setApiTranslation(cached)
        }
        return
      }

      // Prevent duplicate requests for same text
      if (translationRequestedRef.current) {
        return
      }
      
      translationRequestedRef.current = true
      setIsTranslating(true)
      
      try {
        // This will be batched automatically by translationService
        const translated = await translate(sourceText, currentLanguage.code)
        if (mountedRef.current && translated && translated !== sourceText) {
          setApiTranslation(translated)
        }
      } catch (error) {
        console.error("Translation API error:", error)
      } finally {
        if (mountedRef.current) {
          setIsTranslating(false)
          translationRequestedRef.current = false
        }
      }
    }

    fetchTranslation()
  }, [sourceText, currentLanguage.code, dictTranslation, skipTranslation, translate])

  // Determine what to display
  let displayText = sourceText
  if (currentLanguage.code === "ar" && !skipTranslation) {
    if (dictTranslation) {
      displayText = dictTranslation
    } else {
      // Check cache first for immediate display
      const cached = getCachedApiTranslation()
      if (cached) {
        displayText = cached
      } else if (apiTranslation) {
        displayText = apiTranslation
      }
    }
  }

  // If children is not a string, just render it as-is
  if (typeof children !== 'string' && !text) {
    return <Component className={className}>{children}</Component>
  }

  return (
    <Component className={className}>
      {displayText}
    </Component>
  )
}

TranslatedText.displayName = 'TranslatedText'

export default TranslatedText
